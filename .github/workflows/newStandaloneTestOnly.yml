name: CI - New Standalone Test

on:
    push:
        paths:
            - 'BalanceIT/BalanceITUnityGame/Assets/**'
            - 'BalanceIT/BalanceITUnityGame/Packages/**'
            - 'BalanceIT/BalanceITUnityGame/ProjectSettings/**'
    workflow_dispatch: {}
jobs:
    # Testrunner Step
    testrunner:
        name: Testrun
        runs-on: ubuntu-latest
        steps:
            #StandaloneTest Runnen mit GameCI
            - name: Run StandaloneTest
              id: standalone
              uses: game-ci/unity-test-runner@v4
              env:
                UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
                UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
                UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
              with:
                projectPath: BalanceIT/BalanceITUnityGame/
                githubToken: ${{ secrets.CIGITHUB_TOKEN }}
                testmode: standalone
                artifactsPath: standalone-artifacts
            #TestResults uploaden
            - name: Upload Test Result
              uses: actions/upload-artifact@v4
              if: always()
              with:
                name: Test results for StandaloneTest
                path: standalone-artifacts
    # Build Step
    buildProject:
        name: ${{ matrix.target-platform  }}
        runs-on: ${{  matrix.os  }}
        needs: testrunner
        if: success()
        steps:
            - uses: actions/checkout@v4
            - uses: actions/cache@v4
              with:
                path: BalanceIT/BalanceITUnityGame/Library
                key: Library-${{  matrix.unity-version  }}-${{  matrix.target-platform  }}
            - uses: game-ci/unity-builder@v4
              env:
                UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
                UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
                UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
                with:
                targetPlatform: ${{  matrix.target-platform  }}
                projectPath: BalanceIT/BalanceITUnityGame
                unityVersion: ${{  matrix.unity-version  }}
                buildName: BalanceITUnityGameBuild
            - uses: actions/upload-artifact@v4
              with:
                name: ${{  matrix.target-platform  }}
                path: build/${{  matrix.target-platform  }}
        strategy:
            matrix:
                unity-version:
                    - 2023.2.20f1
                    - auto
                os:
                    - ubuntu-latest
                    - windows-latest
                include:
                    - os: ubuntu-latest
                      target-platform: StandaloneLinux64
                    - os: windows-latest
                      target-platform: StandaloneWindows64